services:
  # 1. PostgreSQL 데이터베이스 서비스
  - name: db
    type: psql
    plan: free # 무료 플랜으로 시작 (필요시 유료 플랜으로 변경 가능)
    pvs:
      size: 1 # 1GB 스토리지
    properties:
      - key: max_connections
        value: 20 # 무료 플랜의 최대 연결 수
    ipAllowList: [] # 모든 IP에서 접근 허용 (보안을 위해 필요시 특정 IP로 제한)

  # 2. Redis 서비스
  - name: redis
    type: redis
    plan: free

  # 3. 장고 백엔드 서비스
  - name: backend
    type: web
    plan: free # 무료 플랜
    env: docker # Dockerfile을 사용하여 빌드
    dockerfilePath: ./Dockerfile
    dockerContext: .
    autoDeploy: true # Git 푸 시 자동 배포 활성화
    envVars:
      - key: DATABASE_URL
        fromService:
          type: psql
          name: db
          property: connectionString # db 서비스의 연결 문자열을 가져옴
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis
          property: connectionString
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings_production # 운영 환경용 설정 사용
      - key: SECRET_KEY
        generateValue: true # 렌더에서 강력한 시크릿 키를 자동 생성
      - key: WEB_CONCURRENCY
        value: 4 # Gunicorn 워커 수 (무료 플랜에 적합)
      - key: PYTHON_VERSION
        value: 3.11.4
    dockerCommand: gunicorn config.wsgi:application --bind 0.0.0.0:$PORT
    preDeployCommand: python manage.py migrate

  # 4. 프론트엔드 정적 사이트 서비스
  - name: frontend
    type: static
    plan: free # 무료 플랜
    autoDeploy: true
    buildCommand: |
      cd frontend
      npm install
      npm run build
    staticPublishPath: ./frontend/dist
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: backend
          property: url # 백엔드 서비스의 공개 URL을 가져옴
